<h1>Patient Information for <%= full_name(@record) %></h1>
<div class="row">
<!-- Show measure calculation unless the list is for a product test, Cypress is in ATL Mode and the current user is not an ATL or admin -->
<% unless @product_test && hide_patient_calculation? %>
  <div class="col-md-6">
    <h2>Measure Information</h2>
    <% if @measures.where(continuous_variable: true).length.positive? %>
      <table class="table table-condensed">
        <thead>
          <tr>
            <td></td>
            <% RecordsHelper::CV_POPULATION_KEYS.each do |population| %>
              <th scope="col" class="text-center"><%= population_label(@bundle, population) %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @measures.where(continuous_variable: true).sort_by{ |m| [m.cms_int, m.sub_id] }.each do |m| %>
            <tr>
              <th class="abbreviated" scope="row">
                <%= m.display_name %>
              </th>

              <% RecordsHelper::CV_POPULATION_KEYS.each do |population| %>
                <td class="text-center">
                  <span class="sr-only">Measure <%= m.display_name %> population <%= population %> result: </span>
                  <%= render 'calculation_result_icon', :result => get_result_value(@results, m, population), :episode_of_care => m.episode_of_care %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>

    <% if @measures.where(continuous_variable: false).length.positive? %>
      <table class="table table-condensed">
        <thead>
          <tr>
            <td></td>
            <% RecordsHelper::PROPORTION_POPULATION_KEYS.each do |population| %>
              <th scope="col" class="text-center"><%= population_label(@bundle, population) %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @measures.where(continuous_variable: false).sort_by{ |m| [m.cms_int, m.sub_id] }.each do |m| %>
            <tr>
              <th class="abbreviated" scope="row">
                <%= m.display_name %>
              </th>
              <% RecordsHelper::PROPORTION_POPULATION_KEYS.each do |population| %>
                <td class="text-center">
                  <span class="sr-only">Measure <%= m.display_name %> population <%= population %> result: </span>
                  <%= render 'calculation_result_icon', :result => get_result_value(@results, m, population), :episode_of_care => m.episode_of_care %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
<% end %>

  <div class="col-md-6">
    <h2>Patient Details</h2>
    <dl class="dl-horizontal">
      <dt>DOB</dt><dd><%= display_time(@record.birthDatetime) %></dd>
      <dt>Gender</dt><dd><%= full_gender_name(@record.gender) %></dd>
      <dt>Race</dt><dd><%= @record.get_data_elements('patient_characteristic','race').first['dataElementCodes'].first['descriptor'] %></dd>
      <dt>Ethnicity</dt><dd><%= @record.get_data_elements('patient_characteristic','ethnicity').first['dataElementCodes'].first['descriptor'] %></dd> 

      </dl>

    <% RecordsHelper::SECTIONS.each do |s| %>
      <div class="panel panel-default patient-details">
        <div class="panel-heading"><h3 class='panel-title'><%= s.titleize %></h3></div>
          <div class="panel-body">
          <% @record.get_data_elements(s).each do |data| %> 
              <div class="entry">
              <h5><b>Date/Time:</b></h5> <h5><%= data['authorDatetime'] %></h5>
              <h5><b>Description:</b></h5> <h5><%= data['description'] %></h5>
              <h5><b> Principal Diagnosis:</b></h5> <h5><%= data['diagnoses'].first['descriptor'] if data['diagnoses'] && data['diagnoses'].any? %></h5>
              <h5><b>Length Of Stay:</b></h5> <%= render 'units', :quantity => data['lengthOfStay'] %>
              <h5><b>Dosage:</b></h5> <%= render 'units', :quantity => data['dosage'] %>
              <h5><b>Results:</b></h5> <%= render 'units', :quantity => data['result'] if data['result'].is_a?(Hash)%>
              <% if data['result'].is_a?(Array) %>

              <% end %>
              <h5><b>Dicharge Status :</b></h5> <h5><%= data['dischargeDisposition']['descriptor'] if data['dischargeDisposition'] != nil %></h5>
              <h5><b>Facility Location :</b></h5> <h5><%= data['facilityLocations'].first['Code']['descriptor'] if data['facilityLocations'] && data['facilityLocations'].any? %></h5>
                <% data['dataElementCodes'].each do |dec| %>
                 <h5><b>Code :</b></h5>   <h5><dt><%= dec['code_system'] %></dt><dd><%= dec['code'] %></dd></h5><br>
                <% end %>
              </dl>
              
              </dl>
            </div>
            <% end %>
          </div>
      </div>
    <% end %>
  </div>
</div>