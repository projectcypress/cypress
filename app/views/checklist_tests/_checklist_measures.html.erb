<% if @product_test.tasks[0].most_recent_execution && @product_test.tasks[0].most_recent_execution.incomplete? %>
<script>
  $.ajax({url: "<%= request.env['PATH_INFO'] %>", type: "GET", dataType: 'script', data: { partial: 'checklist_measures' }});
</script>
<% end %>
<div id='save_options' >
  <% unless product_test.status != 'passing' %>
                  <%= render :partial => 'alert', locals: {
                                                  alert_type: 'warning',
                                                  messages: 'Saving this checklist will overide previous results.',
                                                  confirmation: 'Yes, let me save this checklist' } %>
<% end %>
<% measures = product_test.measures %>
<% if measures %>
  <%= bootstrap_nested_form_for([product, product_test], :url => { :controller => 'checklist_tests', :action => 'update' }) do |f| %>
    <% measures.each do |measure| %>
      <div class = 'panel-group' id = '<%= measure.cms_id %>' disabled = true>
        <div class = 'panel panel-default'>
          <div class = 'panel-heading'>
            <h1 class='panel-title'>
              <%= "#{measure.cms_id} #{measure.name}" %>
            </h1>
          </div>
          <div class = 'panel-body'>
            <div class = 'checklist-panel'>
              <table class = 'table table-condensed'>
                <thead>
                  <tr>
                    <th class = 'col-sm-1' scope = 'col'>Validated in QRDA</th>
                    <th class = 'col-sm-2' scope = 'col'>Data Criteria</th>
                    <th class = 'col-sm-2' scope = 'col'>Value Set(s)</th>
                    <th class = 'col-sm-2' scope = 'col'>Recorded Code</th>
                    <th class = 'col-sm-1' scope = 'col'>Required Attributes</th>
                    <th class = 'col-sm-2' scope = 'col'>Attribute Details/Value Set</th>
                    <th class = 'col-sm-2' scope = 'col'>Recorded Attribute Value</th>
                  </tr>
                </thead>
                <tbody>
                  <%= f.fields_for :checked_criteria, product_test.checked_criteria.all(measure_id: measure.id) do |criteria_field| %>
                    <% criteria = measure.hqmf_document[:data_criteria].select { |key, value| key == criteria_field.object.source_data_criteria }.values.first %>
                    <% if criteria.has_key?('description') %>
                      <tr>
                        <td>
                          <% if criteria_field.object.passed_qrda %>
                            <span class="sr-only">Passes QRDA</span>
                            <i class = 'fa fa-fw fa-check text-success' aria-hidden="true"></i>
                          <% else %>
                            <i class = 'fa fa-fw fa-play-circle text-info invisible' aria-hidden="true"></i>
                          <% end %>
                        </td>
                        <% valuessets = criteria_field.object.get_all_valuesets_for_dc(measure) %>
                        <% if valuessets.empty? %>
                          <td/>
                          <td/>
                          <td/>
                        <% else %>
                          <td><%= criteria[:description].chomp(': ' + criteria[:title]) %></td>
                          <td><span>
                            <ul class='list-unstyled'>
                            <% valuessets.each do |vs| %> 
                            <li class="valueset-listitem"><%= "#{lookup_valueset_name(vs)}" %></li>
                            <% end %>
                            </ul>
                          </span></td>
                          <td>
                            <% if criteria_field.object.complete?.nil? %>
                              <i class = 'fa fa-fw fa-play-circle text-info invisible' aria-hidden="true"></i>
                            <% elsif criteria_field.object.code_complete %>
                              <i class = 'fa fa-fw fa-check text-success' aria-hidden="true"></i>
                            <% else %>
                              <i class = 'fa fa-fw fa-times text-danger' aria-hidden="true"></i>
                            <% end %>
                            <%= criteria_field.text_field :code, hide_label: true %>
                          </td>
                        <% end %>
                        <td><%= checklist_test_criteria_attribute(measure, criteria) %></td>
                        <td><%= render partial: 'checklist_tests/field_values', locals: { field_values: criteria['field_values'], negation: criteria['negation_code_list_id'], result: criteria['value']} if criteria['field_values'] || criteria['negation_code_list_id'] || criteria['value'] %></td>
                        <% if coded_attribute?(criteria) %>
                          <td>
                            <% if criteria_field.object.complete?.nil? %>
                              <i class = 'fa fa-fw fa-play-circle text-info invisible' aria-hidden="true"></i>
                            <% elsif criteria_field.object.attribute_complete %>
                              <i class = 'fa fa-fw fa-check text-success' aria-hidden="true"></i>
                            <% else %>
                              <i class = 'fa fa-fw fa-times text-danger' aria-hidden="true"></i>
                            <% end %>
                            <%= criteria_field.text_field :attribute_code, hide_label: true %>
                          </td>
                        <% elsif criteria['value'] && criteria['value'].type != 'CD' || criteria['field_values'] %>
                          <td>
                            <% if criteria_field.object.complete?.nil? %>
                              <i class = 'fa fa-fw fa-play-circle text-info invisible' aria-hidden="true"></i>
                            <% elsif criteria_field.object.result_complete %>
                              <i class = 'fa fa-fw fa-check text-success' aria-hidden="true"></i>
                            <% else %>
                              <i class = 'fa fa-fw fa-times text-danger' aria-hidden="true"></i>
                            <% end %>
                            <%= criteria_field.text_field :recorded_result, hide_label: true %>
                          </td>
                        <% else %>
                          </td>
                        <% end %>
                      </tr>
                    <% end %>
                  <% end %>
                </tbody>
              </table>
            </div>
            <% if product_test.status != 'passing' %>
              <div class = 'panel-footer'>
                <%= f.submit 'Save', class: 'btn btn-default' %>
                <span class = 'small-indent'>This saves the entire checklist page</span>
              </div>
            <% else %>
              <div class = 'panel-footer'>
                <%= f.submit 'Save', class: 'btn btn-danger', disabled: true %>
                <span class = 'small-indent'>This saves the entire checklist page, and will override previous results</span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>
</div>