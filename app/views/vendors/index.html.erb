<%= javascript 'vendors' %>

<div id="container" class="container">
  <%= render :partial=>"shared/header" %>

  <div class="buffered">
    <section id="pageButtons">
      <%= link_to "Add EHR Vendor", new_vendor_path, {:class=>"cmd"} %>
      <%= link_to "Master Patient List", patients_path, {:class=>"cmd"} %>
      <nav class="breadcrumb">
        <span>Certification Dashboard</span>
      </nav>
    </section>

    <section class="information bordered">  
      <p>
        Welcome to Cypress! This is the Certification Dashboard that displays the names of the EHR vendors and the status of their products being tested.
        You can begin by adding an EHR vendor or simply explore the complete Cypress Test Deck by clicking on "Master Patient List" above.
      </p>
    </section>

    <section id="vendor_list">
      <table class="table">
        <thead>
          <tr>
            <th><!-- expander toggle column --></th>
            <th>EHR Vendor Name</th>
            <th>Products Tested</th>
            <th>Passing</th>
            <th>Not Passing</th>
            <th>Date of Last Test</th>
            <th></th>
          </tr>
        </thead>
        <% vendors_by_status(@vendors).each do |result_status, result_vendors|
          next if result_vendors.empty? %>
          <% result_vendors.each do |vendor| %>
            <%
            tested = passing = failing = '--'
            dot_color = result_status
            dot_color = "incomplete" if vendor.products.empty?
            if !vendor.products.empty?
              first_td_class = 'expander toggle'
              passing = vendor.count_passing.to_s + ' products'
              failing = [0,(vendor.count_tested - vendor.count_passing)].max.to_s + ' products'
              tested = vendor.count_tested.to_s + ' / ' + vendor.products.size.to_s + ' products'
            end %>
            <tbody>
              <tr>
                <td class="<%= first_td_class %> tog" data-code="<%= vendor.id %>"></td>
                <td class="vendorname"><a href="<%= vendor_path(vendor.id) %>"><%= vendor.name %></a></td>
                <td><%= tested %></td>
                <td><span class="<% if vendor.count_passing > 0 %> pass <% end %> product"><%= passing %></span></td>
                <td><span class="<% if vendor.count_tested - vendor.count_passing > 0 %> fail <% end %> product"><%= failing %></span></td>
                <td><!-- last executed intentionally blank --></td>
                <td class="align-right"><%= link_to 'delete', { :action => 'destroy', :id => vendor }, :class => 'cmd del', :method => :delete, :confirm => 'Are you sure?' %></td>
              </tr>
              <% if !vendor.products.empty?
                vendor.products.each do |product|
                  last_executed = 0
                  product.product_tests.each do |test|
                    next if test.test_executions.empty?
                    last_executed = [last_executed, test.test_executions.ordered_by_date.to_a.last].max
                  end
                  if product.passing?
                    product_status = 'pass'
                  else
                    product_status = 'fail'
                  end
                  if last_executed == 0
                    last_executed = '--'
                    product_status = 'incomplete'
                  else
                    last_executed = last_executed.strftime('%d %b %Y %l:%M%P')
                  end
                  if product.product_tests.empty?
                    tests_passing = tests_failing = '--'
                  else
                    tests_passing = product.count_passing.to_s + ' / ' + product.product_tests.size.to_s + ' tests'
                    tests_failing = product.count_failing.to_s + ' / ' + product.product_tests.size.to_s + ' tests'
                  end
                %>

                  <tr class="sub_rows <%= vendor.id %>">
                    <td><!-- expando intentionally blank --></td>
                    <td><span class="<%= product_status %>-icon"><a href="<%= product_path(product) %>"><%= product.name %></a></span></td>
                    <td><span class="version"><%= product.version %> </span></td>
                    <td><span class="<% if product.count_passing > 0 %> pass <% end %> test-score"><%= tests_passing %></span></td>
                    <td><span class="<% if product.count_failing > 0 %> fail <% end %> test-score"><%= tests_failing %></span></td>
                    <td><%= last_executed %></td>
                    <td><!-- delete intentionally blank --></td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          <% end %>
        <% end %>
      </table>
    </section>

    <%= render :partial=>"shared/legend" %>
  </div>
</div>
