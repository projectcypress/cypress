{
  "endorser": "NQF",
  "id": "0348",
  "oids": [
    "1.1.1"
  ],
  "bundle_id" : {"$oid" : "4fdb62e01d41c820f6000001"},
  "hqmf_id": "0348",
  "cms_id": "CMS0v2",
  "type" : "eh",
  "population_ids": {
    "IPP": "ipp_0348",
    "DENOM": "denom_0348",
    "NUMER": "num_0348",
    "MSRPOPL": "popl"
  },
  "name": "A fake measure",
  "properties": [
    "NQF_Retooled_Measure_0002.xlsx.json"
  ],
  "hqmf_document": {
    "data_criteria" : {}
    },
  "description": "The percentage of children 2‐18 years of age who were diagnosed with Pharyngitis, dispensed an antibiotic and received a group A streptococcus (strep) test for the episode.",
  "category": "Miscellaneous",
  "steward": "NCQA",
  "parameters": {
    "effective_date": {
      "description": "Effective end date for measure",
      "type": "number",
      "format": "utc-sec"
    }
  },
  "patient": {
    "birthdate": {
      "description": "Date of birth",
      "type": "number",
      "standard_category": "characteristic",
      "format": "utc-sec",
      "codes": [
        {
          "set": "HL7",
          "version": "3.0",
          "values": [
            "00110"
          ]
        }
      ]
    }
  },
  "IPP": {
    "and": [
      {
        "category": "Patient Characteristic",
        "title": "2 <= age <= 18"
      }
    ]
  },
  "DENOM": {
    "and": [
      {
        "category": "Encounter",
        "title": "Ambulatory encounter, including pediatrics during the measurement period"
      },
      {
        "category": "Diagnosis Active",
        "title": "Pharyngitis, occuring during encounter"
      },
      {
        "or": [
          {
            "category": "Medication Active",
            "title": "Pharyngitis antibiotics 0 to 3 days after encounter"
          },
          {
            "category": "Medication Order",
            "title": "Pharyngitis antibiotics 0 to 3 days after encounter"
          },
          {
            "category": "Medication Dispensed",
            "title": "Pharyngitis antibiotics 0 to 3 days after encounter"
          }
        ]
      },
      {
        "category": "Medication NOT Active",
        "title": "Pharyngitis antibiotics <= 30 days after encounter"
      },
      {
        "category": "Medication NOT Ordered",
        "title": "Pharyngitis antibiotics <= 30 days after encounter"
      },
      {
        "category": "Medication NOT Dispensed",
        "title": "Pharyngitis antibiotics <= 30 days after encounter"
      }
    ]
  },
  "NUMER": {
    "or": [
      {
        "category": "Laboratory Test Performed",
        "title": "Group A streptococcus test 0 to 3 days before medication active, occurring <= 3 days after encounter"
      },
      {
        "category": "Laboratory Test Performed",
        "title": "Group A streptococcus test 0 to 3 days before medication order, occurring <= 3 days after encounter"
      },
      {
        "category": "Laboratory Test Performed",
        "title": "Group A streptococcus test 0 to 3 days before medication dispensed, occurring <= 3 days after encounter"
      },
      {
        "category": "Laboratory Test Result",
        "title": "Group A streptococcus test 0 to 3 days after medication active, occurring <= 3 days after encounter"
      },
      {
        "category": "Laboratory Test Result",
        "title": "Group A streptococcus test 0 to 3 days after medication order, occurring <= 3 days after encounter"
      },
      {
        "category": "Laboratory Test Result",
        "title": "Group A streptococcus test 0 to 3 days after medication dispensed, occurring <= 3 days after encounter"
      }
    ]
  },
  "DENEX": {
  },
  "map_fn": "function () {\n  var patient = this;\n  var measure = patient.measures[\"0002\"];\n  if (measure==null)\n    measure={};\n\n  <%= init_js_frameworks %>\n\n  var day = 24*60*60;\n  var year = 365 * day;\n  var effective_date =  <%= effective_date %>;\n  var earliest_encounter = effective_date - year;\n  var earliest_birthdate =  effective_date - 18 * year;\n  var latest_birthdate =    effective_date - 2 * year;\n\n  var meds_prescribed_after_encounter = [];  // computed by denominator, used by numerator\n\n\n  var population = function() {\n    return inRange(patient.birthdate, earliest_birthdate, latest_birthdate);\n  }\n  \n  var denominator = function() {\n\n    var encounters = normalize(measure.encounter_ambulatory_including_pediatrics_encounter)\n    if (!inRange(encounters, earliest_encounter, effective_date))\n      return false;\n\n    var pharyngitis_diagnoses_during_encounter = allDiagnosesDuringEncounter(measure.pharyngitis_diagnosis_active, encounters, earliest_encounter, effective_date);\n\n    if(pharyngitis_diagnoses_during_encounter.length == 0){\n        return(false);\n    }\n\n    var meds = normalize(measure.pharyngitis_antibiotics_medication_dispensed, \n                         measure.pharyngitis_antibiotics_medication_order, \n                         measure.pharyngitis_antibiotics_medication_active );\n    var result = 0;\n    var threeDays = 3 * day;\n    var thirtyDays = 30 * day;\n    \n    var medsThreeAfterAndNotThirtyBefore = function(timeStamp) {\n      var match=false;\n      for (var i=0; i<meds.length;i++) {\n        if (meds[i]>=timeStamp){\n            if (meds[i] <= (timeStamp+threeDays)) { // meds within three days of timestamp\n                match=true;  // keep on looking for prior meds\n                // if meds[i] is ever matched as true, mark it as a match for use in the numerator\n                meds_prescribed_after_encounter.push(meds[i]);\n            }\n        } else if(meds[i] >= (timeStamp-thirtyDays)) { // meds are before timestamp, are they within 30 days prior to timestamp?\n                match=false;\n                break;    // if you find one of these, the search is over\n        }\n      }\n      return match;\n    };\n\n    /*  These encounters are the \"EVENTS\" in the revised spec */\n\n    var matchingEncounters = _.select(pharyngitis_diagnoses_during_encounter, medsThreeAfterAndNotThirtyBefore);\n       \n    return matchingEncounters.length > 0;\n  };\n\n  var numerator = function() {\n \n    /* o OR: “Laboratory test performed: group A streptococcus test” <= 3 days before or simultaneously to “Medication active: pharyngitis antibiotics”, occurring <= 3 days after “EVENT”  */\n\n    return (actionFollowingSomething(  // test precedes medication by less than 3 days\n      measure.group_a_streptococcus_test_laboratory_test_performed, meds_prescribed_after_encounter, 3*day));\n  }\n\n  var exclusion = function() {\n    return false;\n  }\n\n  map(patient, population, denominator, numerator, exclusion);\n};\n"
}
